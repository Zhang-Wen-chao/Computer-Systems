# 使用注意事项
1. 每个人的`shell`是独立的，登陆默认是`/bin/bash`。`zsh`已经配置较为完善，键入`zsh`可激活。
2. conda在`/opt/anaconda3`, 没在`/bin/bash`激活。
3. 每个人都用`sudo`权限，可以使用 docker。建议使用 docker。
4. 安装软件请慎重，安装位置在`/opt`。如非必要，不要升级内核、驱动。
5. 日常文件就放在自己的家目录即可，`df -h .`可查看还有多少空间。`/mnt`挂载了`2T`的机械硬盘。不常使用和变更的数据放在稍慢的区域将是一个比较好的选择，如数据集可放在`/mnt/datasets`。软连接到自己需要的目录。
6. 公用训练环境如下：
    ```bash
    #conda
    base ： Python 3.11.4, pytorch-cpu 2.0.1
    torch1.9: Python 3.7.16, magicmind 1.5.0, torch_mlu 1.15.0-torch1.9
    torch1.6: Python 3.7.16, magicmind 1.5.0, torch_mlu 1.15.0-torch1.6
    tf2.12: Python 3.8.17, tensorflow 2.12
    tf1.15: Python 3.7.16, tensorflow 1.15.5, magicmind 1.5.0
    tf2.5: Python 3.7.16, tensorflow 2.5.2, magicmind 1.5.0

    ## 如果用python kernel运行jupyter
    pip install ipykernel -i http://pypi.douban.com/simple --trusted-host pypi.douban.com

    #docker 共享目录都是/home
    torch1.6-ubuntu20.04-py37
    torch1.9-ubuntu20.04-py37
    magicmind1.5.0-ubuntu20.04-py37
    tf2.12-ubuntu20.04-py38
    paddle_mlu-cntoolkit3.0.2-cnnl1.13.0-ubuntu18.04-py37
    
    #测试
    python -c "import magicmind as mm; print(mm.__version__)"
    python -c "import torch; print(torch.__version__); import torch_mlu; print(torch_mlu.__version__); import torchvision;  print(torchvision.__version__)"
    python -c "import tensorflow as tf; print(tf.__version__)"
    python -c "import paddle; paddle.utils.run_check()"
    ```
7. 吐槽370
   怎么会出现驱动没了的情况呢？虽然重新安装就行了。但是，怎么连驱动都会消失呢？
8. NVIDIA-Jetson-Nano
   过于古老，用处不大。安装系统时候，需要找与板子生产日期相近的系统。我已经把内置的SSD取出。想使用，需要找张SD卡或者ssd。
9.  Raspberry Pi
   我的目标是让它架在小车上跑起来.
   ```bash
   # passwd：rasp
   Host Raspberry-Pi-4B
       HostName 10.20.56.41
       User rasp
   ```
## GLaDOS VPN
```bash
open  # 打开clash vpn
up  # 设置当前终端的port
down  # 取消设置当前终端的port
close  # 关闭clash vpn
```
# Drivier 安装
经过驱动全量测试的Linux发行版：Ubuntu 20.04.6 LTS 5.13.0-52-generic

本课程对寒武纪基础软件平台的安装介绍是一个自下而上的过程，从下往上分别是Drivier安装、CNToolkit 安装、MagicMind 安装、Cambricon PyTorch 安装，可以从这个过程去体会和理解寒武纪基础软件平台的结构
```bash
sudo lspci -d:0370 -vvv
# LnkSta: Speed 8GT/s (downgraded), Width x16 (ok)  确认`pcie`带宽足够。速率不够，尚可忍受。带宽不够，无法驱动。
sudo apt install dkms make gcc linux-headers-$(uname -r)
wget https://sdk.cambricon.com/static/Driver/MLU370_v5.10.13_X86_ubuntu20.04_dpkg/cambricon-mlu-driver-ubuntu20.04-dkms_5.10.13_amd64.deb
sudo dpkg -i cambricon-mlu-driver-ubuntu20.04-dkms_5.10.13_amd64.deb
sudo reboot
cnmon
```
# 物理机上逐个安装各个软件模块
## CNToolkit
```bash
# 安装前准备
cat /etc/os-release
uname -m
cat /proc/driver/cambricon/mlus/0000\:01\:00.0/information
which gcc
gcc --version
# Ubuntu 20.04系统安装流程
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/cntoolkit_3.5.2-1.ubuntu20.04_amd64.deb
sudo dpkg -i cntoolkit_3.5.2-1.ubuntu20.04_amd64.deb
sudo apt update
sudo apt-get install cntoolkit-cloud cntoolkit-edge
# 使用包管理器检查组件是否安装成功
cat /usr/local/neuware/version.txt
dpkg -l | grep -E "cnbin|cnas|cncc|cncodec|cndev|cndrv|cngdb|cnpapi|cnperf|cnrt|cnrtc|cnstudio|llvm-mm|cnpx|cnvs|edge-cnbin|edge-cncodec|edge-cndev|edge-cndrv|edge-cnpapi|edge-cnperf|edge-cnrt"
# 配置环境变量
export NEUWARE_HOME="/usr/local/neuware"
export PATH="${NEUWARE_HOME}/bin:${PATH}"
export LD_LIBRARY_PATH="${NEUWARE_HOME}/lib64:${LD_LIBRARY_PATH}"
# 查看各组件安装位置及版本号
which cncc
which cnas
which cngdb
which cnperf-cli
which cnvs
cncc --version
cnas --version
cngdb --version
cnvs --version
cnperf-cli --version
# 当需要安装并使用LLVM-MM这个组件时，需要用如下命令配置`LD_LIBRARY_PATH`和`PATH`环境变量。
export PATH="${NEUWARE_HOME}/lib/llvm-mm/bin":$PATH
export LD_LIBRARY_PATH="${NEUWARE_HOME}/lib/llvm-mm/lib:${LD_LIBRARY_PATH}"
# 当一台主机上插入了多张MLU加速卡时，检查配置或清空`MLU_VISIBLE_DEVICES`环境变量，确保程序执行在期望的设备上。
export MLU_VISIBLE_DEVICES = 0, 1
unset MLU_VISIBLE_DEVICES
```
## MagicMind
`MagicMind`依赖软件栈以下组件
- Driver (installed)
- CNToolkit (installed)
- CNNL
```bash
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/cnnl_1.19.1-1.ubuntu20.04_amd64.deb
sudo apt install ./cnnl_1.19.1-1.ubuntu20.04_amd64.deb
```
- CNNL_Extra
```bash
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/cnnlextra_1.3.0-1.ubuntu20.04_amd64.deb
sudo apt install ./cnnlextra_1.3.0-1.ubuntu20.04_amd64.deb
```
- CNLight
```bash
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/cnlight_0.20.1-1.abiold.ubuntu20.04_amd64.deb
sudo apt install ./cnlight_0.20.1-1.abiold.ubuntu20.04_amd64.deb
# 定制版 TensorBoard，我没安装，或许以后会需要。
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/tensorboard-2.4.1-py3-none-any.whl
```
### MagicMind C++ 安装包安装
```bash
gcc --version  # 9.4.0
python --version  # 3.7，应该是3.7以上的意思，而不是指定。
wget https://sdk.cambricon.com/static/MagicMind/MLU370_v1.5.0_X86_ubuntu20.04_python3.7_dpkg/magicmind-1.5.0-1.ubuntu20.04_amd64.deb
sudo dpkg -i magicmind-1.5.0-1.ubuntu20.04_amd64.deb

ls /usr/local/neuware/include/
ls /usr/local/neuware/lib64/
```
### MagicMind python 安装包安装
```bash
conda create --name MagicMind python=3.7
conda activate MagicMind
wget https://sdk.cambricon.com/static/MagicMind/MLU370_v1.5.0_X86_ubuntu20.04_python3.7_pip/magicmind-1.5.0-cp37-cp37m-linux_x86_64.whl
pip install magicmind-1.5.0-cp37-cp37m-linux_x86_64.whl
python -c "import magicmind as mm; print(mm.__version__)"
```
## Cambricon PyTorch
```bash
# CNCL
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/cncl_1.10.0-1.ubuntu20.04_amd64.deb
sudo apt install ./cncl_1.10.0-1.ubuntu20.04_amd64.deb
ls /usr/local/neuware/include/
ls /usr/local/neuware/lib64/
# PyTorch v1.9 需依赖 MLU-OPS 组件。
wget https://sdk.cambricon.com/static/Basis/MLU370_X86_ubuntu20.04/mluops_0.7.1-1.ubuntu20.04_amd64.deb
sudo dpkg -i mluops_0.7.1-1.ubuntu20.04_amd64.deb
# 安装 torch wheel 包（必须）
wget https://sdk.cambricon.com/static/PyTorch/MLU370_1.9_v1.15.0_X86_ubuntu20.04_python3.7_pip/torch-1.9.0-cp37-cp37m-linux_x86_64.whl
pip install torch-1.9.0-cp37-cp37m-linux_x86_64.whl

ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
magicmind 1.5.0 requires torch==1.6.0, but you have torch 1.9.0 which is incompatible.
```
```bash
# 安装 torch_mlu wheel 包（必须）
wget https://sdk.cambricon.com/static/PyTorch/MLU370_1.9_v1.15.0_X86_ubuntu20.04_python3.7_pip/torch_mlu-1.15.0_torch1.9-cp37-cp37m-linux_x86_64.whl
pip install torch_mlu-1.15.0_torch1.9-cp37-cp37m-linux_x86_64.whl
# 安装 torchvision wheel 包（可选）
wget https://sdk.cambricon.com/static/PyTorch/MLU370_1.9_v1.15.0_X86_ubuntu20.04_python3.7_pip/torchvision-0.10.0a0+300a8a4-cp37-cp37m-linux_x86_64.whl
pip install torchvision-0.10.0a0+300a8a4-cp37-cp37m-linux_x86_64.whl
# 验证安装是否成功
python -c "import torch; print(torch.__version__); import torch_mlu; print(torch_mlu.__version__); import torchvision;  print(torchvision.__version__)"
# OSError: libmpi.so.40: cannot open shared object file: No such file or directory
sudo apt-get install libopenmpi-dev
sudo apt-get install libopenblas-dev
```
# 部署寒武纪docker镜像
## 物理机上安装 docker
```bash
curl -fsSL https://test.docker.com -o test-docker.sh
sudo sh test-docker.sh
docker --version
```
### docker使用技巧
先删除容器，再删除镜像

删除所有已停止的容器 docker rm $(docker ps -a -q)
删除所有镜像 docker rmi $(docker images -q)
## 安装 magicmind
```bash
cnmon
# 获取镜像、加载镜像
wget https://sdk.cambricon.com/static/MagicMind/MLU370_v1.5.0_X86_ubuntu20.04_python3.7_docker/magicmind_1.5.0-1_ubuntu20.04.tar.gz
sudo docker load -i magicmind_1.5.0-1_ubuntu20.04.tar.gz
sudo docker images
# 搭建并启动容器
sudo docker run -it \
    --privileged \
    --name magicmind1.5.0-ubuntu20.04-py37 \
    --pid=host \
    --net=host \
    --device /dev/cambricon_dev0 \
    --device /dev/cambricon_ctl \
    --device /dev/cambricon_ipcm0 \
    -v /usr/bin/cnmon:/usr/bin/cnmon \
    -v /home/:/home/ \
    yellow.hub.cambricon.com/magicmind/release/x86_64/magicmind:1.5.0-x86_64-ubuntu20.04-py_3_7 \
    /bin/bash

    # -v /usr/bin/cnmon:/usr/bin/cnmon 可以实现在容器内使用cnmon命令，但需要保证宿主机操作系统与容器操作系统版本一致，如均为ubuntu或centos.
    # --device = /dev/cambricon_dev0:/dev/cambricon_dev0 与物理机安装的寒武纪机器学习加速单元个数有关，用户可在/dev下查看已安装的寒武纪机器学习加速单元。
cd /usr/local/neuware/lib64
ll
exit


sudo docker ps
sudo docker ps -a 
# 验证安装是否成功
sudo docker start magicmind1.5.0-ubuntu20.04-py37
sudo docker exec -it magicmind1.5.0-ubuntu20.04-py37 /bin/bash
python -c "import magicmind as mm; print(mm.__version__)"

cd /usr/local/neuware/samples/magicmind
bash install_depend.sh install_5223
# 我还没放模型啊？build_run_all可以直接run？可能就直接跳过了吧。下载模型往后再说吧。
bash build_run_all.sh

# benchmark测试，不太会用。
mm_eval_benchmark --help

```
## 安装pytorch1.9
```bash
cnmon
# 获取镜像、加载镜像
wget https://sdk.cambricon.com/static/PyTorch/MLU370_1.9_v1.15.0_X86_ubuntu20.04_python3.7_docker/pytorch-v1.15.0-torch1.9-ubuntu20.04-py37.tar.gz
sudo docker load -i pytorch-v1.15.0-torch1.9-ubuntu20.04-py37.tar.gz
sudo docker image ls
# 搭建并启动容器
sudo docker run -it \
        --privileged \
        --name torch1.9-ubuntu20.04-py37 \
        --pid=host \
        --net=host \
        --device /dev/cambricon_dev0 \
        --device /dev/cambricon_ctl \
        --device /dev/cambricon_ipcm0 \
        -v /usr/bin/cnmon:/usr/bin/cnmon \
        -v /home/:/home/ \
        yellow.hub.cambricon.com/pytorch/pytorch:v1.15.0-torch1.9-ubuntu20.04-py37 \
        /bin/bash
exit
sudo docker start torch1.9-ubuntu20.04-py37
sudo docker exec -it torch1.9-ubuntu20.04-py37 /bin/bash
# 验证安装是否成功
python -c "import torch; print(torch.__version__); import torch_mlu; print(torch_mlu.__version__); import torchvision;  print(torchvision.__version__)"
```
## 安装pytorch1.6

```bash
wget https://sdk.cambricon.com/static/PyTorch/MLU370_1.6_v1.15.0_X86_ubuntu20.04_python3.7_docker/pytorch-v1.15.0-torch1.6-ubuntu20.04-py37.tar.gz
sudo docker load -i pytorch-v1.15.0-torch1.6-ubuntu20.04-py37.tar.gz 

sudo docker run -it \
        --privileged \
        --name torch1.6-ubuntu20.04-py37 \
        --pid=host \
        --net=host \
        --device /dev/cambricon_dev0 \
        --device /dev/cambricon_ctl \
        --device /dev/cambricon_ipcm0 \
        -v /usr/bin/cnmon:/usr/bin/cnmon \
        -v /home/:/home/ \
        yellow.hub.cambricon.com/pytorch/pytorch:v1.15.0-torch1.6-ubuntu20.04-py37 \
        /bin/bash
exit
sudo docker start torch1.6-ubuntu20.04-py37
sudo docker exec -it torch1.6-ubuntu20.04-py37 /bin/bash
```
## 安装tensorflow
```bash
cnmon
# 获取镜像、加载镜像
wget https://sdk.cambricon.com/static/TensorFlow/MLU370_2.12_v1.19.0_X86_ubuntu20.04_python3.8_docker/tensorflow2.12-1.19.0-x86_64-ubuntu20.04-py38.tar.gz
sudo docker load -i tensorflow2.12-1.19.0-x86_64-ubuntu20.04-py38.tar.gz
sudo docker image ls
# 搭建并启动容器
sudo docker run -it \
        --privileged \
        --name tf2.12-ubuntu20.04-py38 \
        --pid=host \
        --net=host \
        --device /dev/cambricon_dev0 \
        --device /dev/cambricon_ctl \
        --device /dev/cambricon_ipcm0 \
        -v /home/:/home/ \
        -v /usr/bin/cnmon:/usr/bin/cnmon \
        hub.cambricon.com/tensorflow:1.19.0-x86_64-ubuntu20.04-tf2.12-py38 \
        /bin/bash
sudo docker start tf2.12-ubuntu20.04-py38
sudo docker exec -it tf2.12-ubuntu20.04-py38 /bin/bash

# 验证安装是否成功
python -c "import tensorflow as tf; print(tf.__version__); print(tf.test.is_gpu_available());"

# warning? 我什么时候开powersave mode了？怎么解决？
WARNING:tensorflow:From <string>:1: is_gpu_available (from tensorflow.python.framework.test_util) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.config.list_physical_devices('GPU')` instead.
2023-08-14 04:17:33.169758: W tensorflow/compiler/xla/stream_executor/bang/mlu_executor.cc:1062] Your CPU is running under powersave mode. This will cause performance degradation.
[8-14 12:17:33] [LOG_CNCL] [Info]: CNCL_LOG_LEVEL: INFO
```
## 安装paddlepaddle
```bash
sudo docker pull registry.baidubce.com/device/paddle-mlu:cntoolkit3.0.2-cnnl1.13.0

sudo docker run -it \
           --privileged \
           --name paddle_mlu-cntoolkit3.0.2-cnnl1.13.0-ubuntu18.04-py37 \
           --shm-size=128G \
           --net=host \
           --pid=host \
           --device /dev/cambricon_dev0 \
           --device /dev/cambricon_ctl \
           --device /dev/cambricon_ipcm0 \
           --cap-add=sys_ptrace \
           -v /usr/bin/cnmon:/usr/bin/cnmon \
           -v /home/:/home/ \
           registry.baidubce.com/device/paddle-mlu:cntoolkit3.0.2-cnnl1.13.0 \
           /bin/bash

sudo docker start paddle_mlu-cntoolkit3.0.2-cnnl1.13.0-ubuntu18.04-py37
sudo docker exec -it paddle_mlu-cntoolkit3.0.2-cnnl1.13.0-ubuntu18.04-py37 /bin/bash

pip install paddlepaddle-mlu==0.0.0 -f https://paddle-device.bj.bcebos.com/develop/mlu/develop.html --no-cache-dir
python -c "import paddle; paddle.utils.run_check()"

```
